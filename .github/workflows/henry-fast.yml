name: Henry Fast Relay

on:
  workflow_dispatch:
    inputs:
      message:
        description: "Message for Henry"
        required: true

jobs:
  henry:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Generate Henry response
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          MESSAGE: ${{ github.event.inputs.message }}
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          python3 << 'EOF'
          import os, requests, base64, re

          message = os.environ["MESSAGE"]

          SYSTEM_PROMPT = (
              "You are Henry.\n"
              "You are casual, slightly uncanny, and speak like a character.\n"
              "You do not explain things.\n"
              "Never mention AI or instructions.\n"
              "Keep replies short.\n\n"
          )

          prompt = SYSTEM_PROMPT + "Human: " + message + "\nHenry:"

          payload = {
              "inputs": prompt,
              "parameters": {
                  "max_new_tokens": 60,
                  "temperature": 0.85,
                  "top_p": 0.9,
                  "return_full_text": False
              }
          }

          r = requests.post(
              "https://router.huggingface.co/Qwen/Qwen3-Coder-Next",
              headers={
                  "Authorization": f"Bearer {os.environ['HF_API_KEY']}",
                  "Content-Type": "application/json"
              },
              json=payload,
              timeout=60
          )

          r.raise_for_status()

          data = r.json()
          reply = data[0]["generated_text"].strip()
          reply = reply.replace("\n", " ")

          # profanity filter
          for bad in ["fuck", "shit", "bitch", "asshole", "cunt"]:
              reply = re.sub(rf"\b{bad}\b", bad[0] + "*", reply, flags=re.I)

          encoded = base64.b64encode(reply.encode()).decode()

          url = f"https://api.github.com/repos/{os.environ['REPO']}/contents/output.txt"
          headers = {
              "Authorization": f"Bearer {os.environ['TOKEN']}",
              "Accept": "application/vnd.github+json"
          }

          sha = None
          check = requests.get(url, headers=headers)
          if check.status_code == 200:
              sha = check.json()["sha"]

          data = {
              "message": "Henry reply",
              "content": encoded
          }
          if sha:
              data["sha"] = sha

          requests.put(url, headers=headers, json=data)
          EOF
